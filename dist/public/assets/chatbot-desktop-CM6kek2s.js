import{u as V,d as Q,r as o,S as A,j as e,t as U,p as X,B as G,at as Y,q as Z,v as ee,E as f,as as se}from"./main-CzoStkir.js";import{S as te}from"./scroll-area-WtX7C85G.js";import{H as ne}from"./header-desktop-BFuvCPr5.js";import"./profile-avatar-D9cO9Vj4.js";import"./notepad-text-7swJf2ST.js";const oe=`
  .safe-area-top {
    padding-top: env(safe-area-inset-top);
  }
  .safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
  @media (max-width: 640px) {
    .chatbot-mobile-optimized {
      font-size: 14px;
    }
  }
  /* Prevent zoom on input focus on iOS */
  @media screen and (max-width: 767px) {
    input, textarea, select, button {
      font-size: 16px !important;
    }
  }
  /* Improve touch targets */
  button, .touch-target {
    min-height: 44px;
    min-width: 44px;
  }
`;function re({content:b,isUser:F}){const T=v=>v.split(`

`).map((l,p)=>{if(l.trim()==="")return null;if(l.includes("â€¢")||l.includes("*")||l.includes("-")){const r=l.split(`
`).filter(m=>m.trim()),u=[],S=[];return r.forEach(m=>{const a=m.trim();a.startsWith("â€¢")||a.startsWith("*")||a.startsWith("-")?u.push(a.replace(/^[â€¢*-]\s*/,"")):S.push(a)}),e.jsxs("div",{className:"mb-4 last:mb-0",children:[S.length>0&&e.jsx("div",{className:"mb-3",children:S.map((m,a)=>e.jsx("p",{className:"mb-2 last:mb-0",children:m},a))}),u.length>0&&e.jsx("ul",{className:"space-y-2 ml-0",children:u.map((m,a)=>e.jsxs("li",{className:"flex items-start",children:[e.jsx("span",{className:`inline-block w-1.5 h-1.5 rounded-full mr-3 mt-2.5 flex-shrink-0 ${F?"bg-blue-200":"bg-gray-400"}`}),e.jsx("span",{className:"flex-1 leading-relaxed",children:m})]},a))})]},p)}if(l.includes(":")&&l.split(`
`).length===1){const r=l.split(":");if(r.length===2&&r[0].trim().length<50)return e.jsxs("div",{className:"mb-4 last:mb-0",children:[e.jsxs("h3",{className:`font-semibold mb-2 ${F?"text-blue-100":"text-gray-800"}`,children:[r[0].trim(),":"]}),e.jsx("p",{className:"leading-relaxed pl-2",children:r[1].trim()})]},p)}const x=l.split(`
`).filter(r=>r.trim());return e.jsx("div",{className:"mb-4 last:mb-0",children:x.map((r,u)=>e.jsx("p",{className:"mb-2 last:mb-0 leading-relaxed",children:r.trim()},u))},p)}).filter(Boolean);return e.jsx("div",{className:"space-y-0",children:T(b)})}function me(){const{isAuthenticated:b,student:F}=V(),[,T]=Q(),[v,j]=o.useState([]),[l,p]=o.useState(""),[x,r]=o.useState(!1),[u,S]=o.useState(null),[m,a]=o.useState(null),[H,R]=o.useState(!1),[I,k]=o.useState(null),[N,E]=o.useState(!1),[O,$]=o.useState(!1),[L,ae]=o.useState(A.DEFAULT_LANGUAGE),P=o.useRef(null),M=o.useRef(null),w=o.useRef(null);o.useState(!0),o.useEffect(()=>{if(!b){T("/");return}},[b,T]),o.useEffect(()=>{z()},[v]),o.useEffect(()=>{if(!b)return;const s=new URLSearchParams(window.location.search),t=s.get("sessionId")||s.get("session"),n=s.get("message");t&&(window.history.replaceState({},"","/chatbot"),(async()=>{var c;try{const h=`${f.BASE_URL}${f.ENDPOINTS.CHAT_SESSIONS}`,g=await fetch(h,{headers:y()});if(g.ok){const d=(c=(await g.json()).results)==null?void 0:c.find(C=>C.chatSessionId===t);d?(S(d),R(!1),await W(d.chatSessionId),n&&setTimeout(()=>{_(d,decodeURIComponent(n))},100)):(k(n?decodeURIComponent(n):null),R(!0),S(null),j([]))}}catch(h){console.error("Failed to handle session load:",h)}})())},[b]),o.useEffect(()=>{const s=window.SpeechRecognition||window.webkitSpeechRecognition;if(s){$(!0);const t=new s;t.continuous=A.RECOGNITION_SETTINGS.continuous,t.interimResults=A.RECOGNITION_SETTINGS.interimResults,t.lang=L,t.maxAlternatives=A.RECOGNITION_SETTINGS.maxAlternatives,t.onresult=n=>{let i="";for(let c=0;c<n.results.length;c++)i+=n.results[c][0].transcript;p(i)},t.onstart=()=>{console.log("ðŸŽ¤ Speech recognition started"),E(!0)},t.onend=()=>{console.log("ðŸŽ¤ Speech recognition ended"),E(!1)},t.onerror=n=>{switch(console.error("ðŸŽ¤ Speech recognition error:",n.error),E(!1),n.error){case"no-speech":console.log("ðŸŽ¤ No speech detected");break;case"audio-capture":console.error("ðŸŽ¤ Audio capture failed - check microphone permissions");break;case"not-allowed":console.error("ðŸŽ¤ Microphone permission denied");break;case"network":console.error("ðŸŽ¤ Network error occurred");break;case"aborted":console.log("ðŸŽ¤ Speech recognition aborted");break;default:console.error("ðŸŽ¤ Unknown error:",n.error)}},t.onnomatch=()=>{console.log("ðŸŽ¤ No speech match found"),E(!1)},w.current=t}else console.warn("ðŸŽ¤ Speech Recognition not supported in this browser"),$(!1);return()=>{w.current&&w.current.abort()}},[L]);const z=()=>{var s;(s=P.current)==null||s.scrollIntoView({behavior:"smooth"})},y=()=>({Authorization:`Bearer ${se()}`,"Content-Type":"application/json"}),W=async s=>{try{if(!s||s==="undefined"){console.error("âŒ Invalid session ID:",s);return}const t=`${f.BASE_URL}${f.ENDPOINTS.CHAT_SESSION_MESSAGES(s)}`;console.log("ðŸ“¡ Fetching messages from:",t);const n=await fetch(t,{headers:y()});if(n.ok){const i=await n.json();j(i.messages||[])}else{const i=await n.text();console.error("Failed to load messages:",n.status,i)}}catch(t){console.error("Failed to load messages:",t)}};function J(s){if(!s)return"New Chat";let t=s.trim();return t.length>30&&(t=t.slice(0,30).trim()+"..."),t.charAt(0).toUpperCase()+t.slice(1)}const _=async(s,t)=>{var i;a(null),r(!0);const n={id:`temp-${Date.now()}`,messageType:"user",messageContent:t,createdAt:new Date().toISOString()};j(c=>[...c,n]);try{const c=`${f.BASE_URL}${f.ENDPOINTS.CHAT_SESSION_SEND_MESSAGE(s.chatSessionId)}`;console.log("ðŸ“¤ Sending message to:",c);const h=await fetch(c,{method:"POST",headers:y(),body:JSON.stringify({message:t})});if(h.ok){const g=await h.json();j(d=>[...d.filter(q=>q.id!==n.id),{id:`user-${Date.now()}`,messageType:"user",messageContent:g.userMessage,createdAt:new Date().toISOString()},{id:`bot-${Date.now()}`,messageType:"bot",messageContent:g.botResponse,createdAt:new Date().toISOString()}]);const D=J(t);S(d=>d&&d.sessionTitle==="New Chat"?(fetch(`${f.BASE_URL}${f.ENDPOINTS.CHAT_SESSION_DETAIL(d.chatSessionId)}`,{method:"PATCH",headers:y(),body:JSON.stringify({session_title:D})}).catch(C=>console.error("Failed to update session title:",C)),{...d,sessionTitle:D}):d)}else{const g=await h.text();throw console.error("Failed to send message:",h.status,g),new Error("Failed to send message")}}catch(c){console.error("ðŸ’¥ Send message error:",c),a("Failed to send message. Please try again."),console.error("Failed to send message:",c),j(h=>h.filter(g=>g.id!==n.id))}finally{r(!1),(i=M.current)==null||i.focus()}},B=async()=>{const s=I||l.trim();if(!(!s||x)){if(k(null),p(""),R(!1),!u){try{r(!0);const t=`${f.BASE_URL}${f.ENDPOINTS.CHAT_SESSIONS}`,n=await fetch(t,{method:"POST",headers:y(),body:JSON.stringify({sessionTitle:"New Chat"})});if(n.ok){const i=await n.json();S(i),await _(i,s)}else{const i=await n.text();console.error("Failed to create session:",n.status,i),a("Failed to create session. Please try again.")}}catch(t){a("Failed to create session. Please try again."),console.error("Failed to create session:",t)}finally{r(!1)}return}if(!u.chatSessionId){console.error("âŒ Current session missing chatSessionId:",u),a("Invalid session. Please create a new session.");return}await _(u,s)}},K=()=>{if(!O){console.warn("ðŸŽ¤ Speech recognition not supported");return}if(N)w.current&&w.current.stop(),setTimeout(()=>{l.trim()&&B()},100);else if(w.current)try{p(""),w.current.start()}catch(s){console.error("ðŸŽ¤ Failed to start speech recognition:",s),E(!1)}};return b?e.jsxs("div",{className:"flex min-h-screen bg-gradient-to-br from-sky-50 via-blue-50 to-indigo-50",children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:oe}}),e.jsx(ne,{}),e.jsxs("main",{className:"flex-1 flex flex-col mt-20 transition-all duration-300 md:ml-64 relative h-[calc(100vh-5rem)]",children:[e.jsx("div",{className:"flex-1 overflow-hidden pb-24",children:e.jsx(te,{className:"h-full",children:e.jsx("div",{className:"max-w-full mx-auto px-3 py-4",children:!u||H?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[70vh] px-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-center",children:"Where should we begin?"}),e.jsx("p",{className:"text-md text-[#6B7280] text-center",children:"Ask me anything about your learning journey!"})]}):e.jsxs("div",{className:"space-y-4",children:[v.map((s,t)=>e.jsx("div",{className:`group relative flex ${s.messageType==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`flex items-start gap-3 max-w-[90%] ${s.messageType==="user"?"flex-row-reverse":""}`,children:e.jsx("div",{className:`rounded-xl px-3 pt-2 pb-1 text-sm shadow-sm border ${s.messageType==="user"?"bg-gradient-to-br from-blue-400 to-blue-600 text-white":"bg-white border-white transition-colors"}`,children:e.jsx(re,{content:s.messageContent,isUser:s.messageType==="user"})})})},s.id||t)),x&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"rounded-xl px-4 py-3 bg-white text-[#1F2937] shadow-sm border border-[#E2E8F0] flex items-center gap-2",children:[e.jsx(U,{className:"h-3.5 w-3.5 animate-spin text-[#4F83FF]"}),e.jsx("span",{className:"text-sm text-[#6B7280]",children:"Thinking..."})]})})}),e.jsx("div",{ref:P})]})})})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-white border-t px-2 pt-2 pb-6",children:e.jsxs("div",{className:"w-full",children:[m&&e.jsx("div",{className:"mb-3 p-3 bg-[#FEF2F2] border border-[#FCA5A5] rounded-lg",children:e.jsx("p",{className:"text-sm text-[#DC2626]",children:m})}),e.jsx("form",{className:"w-full",onSubmit:s=>{s.preventDefault(),B()},children:e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx("div",{className:`flex-1 bg-[#F8FAFC] border border-[#E2E8F0] rounded-full transition-shadow duration-200 ${N?"ring-2 ring-[#10B981] ring-offset-2":""}`,children:e.jsx(X,{ref:M,value:I||l,onChange:s=>{I&&k(null),p(s.target.value)},onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),B())},placeholder:"Ask anything...",disabled:x,className:"w-full bg-transparent border-none outline-none shadow-none text-base placeholder-[#6B7280] rounded-full"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[O&&e.jsx(G,{type:"button",onClick:K,disabled:x,variant:"outline",size:"icon",className:`transition-all duration-200 ${N?"bg-[#10B981] hover:bg-[#059669] text-white border-[#10B981]":"bg-[#E5E7EB] hover:bg-[#CBD5E1] text-[#6B7280] border-[#E5E7EB]"} rounded-full`,title:N?"Stop recording and send":"Start voice input","aria-label":N?"Stop recording and send":"Start voice input",children:N?e.jsx(Y,{className:"h-4 w-4"}):e.jsx(Z,{className:"h-4 w-4"})}),e.jsx(G,{type:"submit",disabled:!(l.trim()||I)||x,size:"icon",className:"bg-[#4F83FF] hover:bg-[#3B82F6] text-white transition-all duration-200 disabled:opacity-50 rounded-full",children:x?e.jsx(U,{className:"h-4 w-4 animate-spin"}):e.jsx(ee,{className:"h-4 w-4"})})]})]})}),O&&N&&e.jsx("div",{className:"mt-3 text-center",children:e.jsx("span",{className:"text-[#10B981] text-sm",children:"ðŸŽ¤ Listening... Click âœ“ to stop and send"})})]})})]})]}):null}export{me as default};
